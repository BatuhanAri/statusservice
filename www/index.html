<!DOCTYPE html>
<html lang="tr" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFE Health Dashboard</title>

  <!-- Bazı servisler için ekstra meta (örn. host/port/http_path) -->
  <script>
    window.SERVICE_META = window.SERVICE_META || {
      bind9:      { http: false },
      nats_client:{ http: false },
    };
  </script>

  <meta id="themeColor" name="theme-color" content="#0b1220">

  <style>
    /* -----------------------------
       Tema Değişkenleri
    ------------------------------*/
    :root{
      --bg:#0b1220; --fg:#e8edf7; --muted:#9aa6b2;
      --card:#0f172a; --bd:#1f2a44; --hr:#1c253f; --na:#324158;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --brand1:#2563eb; --brand2:#22d3ee; --brand3:#a78bfa;
      --glow: 0 10px 30px -10px rgba(34,211,238,.35), 0 6px 18px -8px rgba(39,92,211,.35);
      --radius:14px; --focus: 0 0 0 3px rgba(34,211,238,.5);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f9fc; --fg:#0f172a; --muted:#6b7280;
        --card:#ffffff; --bd:#e6ecf5; --hr:#eef2f7; --na:#d1d5db;
        --glow: 0 10px 30px -10px rgba(34,197,94,.25), 0 6px 18px -8px rgba(59,130,246,.25);
      }
    }
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"]{  color-scheme: dark;  }
    :root[data-theme="light"]{
      --bg:#f7f9fc; --fg:#0f172a; --muted:#6b7280;
      --card:#ffffff; --bd:#e6ecf5; --hr:#eef2f7; --na:#d1d5db;
      --glow: 0 10px 30px -10px rgba(34,197,94,.25), 0 6px 18px -8px rgba(59,130,246,.25);
    }
    :root[data-theme="dark"]{
      --bg:#0b1220; --fg:#e8edf7; --muted:#9aa6b2;
      --card:#0f172a; --bd:#1f2a44; --hr:#1c253f; --na:#324158;
    }

    /* -----------------------------
       Reset / Genel
    ------------------------------*/
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(800px 600px at 110% 10%, rgba(167,139,250,.12), transparent 60%),
        var(--bg);
      color:var(--fg);
      letter-spacing:.1px;
    }
    a{color:inherit}
    :focus-visible{outline:none; box-shadow:var(--focus); border-radius:10px}

    /* -----------------------------
       Header
    ------------------------------*/
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(140%) blur(10px);
      background: linear-gradient(90deg, rgba(37,99,235,.85), rgba(59,130,246,.85)) border-box;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:#fff;
      padding:14px 18px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:28px; height:28px; border-radius:9px;
      background: conic-gradient(from 210deg, var(--brand1), var(--brand2), var(--brand3), var(--brand1));
      box-shadow: var(--glow);
    }
    header h1{margin:0; font-size:1.05rem; letter-spacing:.3px}
    .controls{ display:flex; flex-wrap:wrap; gap:8px; justify-self:end; }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);
      color:#fff; padding:8px 12px; border-radius:10px; font-weight:600;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background:#fff; color:#2563eb; border-color:transparent}
    .icon{width:16px;height:16px; display:inline-block}

    .stats{
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      padding:10px 18px; border-bottom:1px solid var(--hr);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
    }
    .pill{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:var(--card); border:1px solid var(--bd); color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:3px}
    .okdot{background:var(--ok)} .baddot{background:var(--bad)} .wardot{background:var(--warn)}
    .score{
      --p: 65;
      position:relative; width:54px; height:54px; border-radius:50%;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), rgba(127,140,160,.25) 0);
      display:grid; place-items:center; color:#fff; font-weight:700; font-size:.8rem;
      border:1px solid var(--bd); box-shadow: var(--glow);
    }
    .score::after{ content:""; position:absolute; inset:6px; border-radius:50%; background:var(--card); }
    .score span{position:relative; z-index:1; color:var(--fg)}

    main#grid{
      display:grid; gap:14px; grid-template-columns:repeat(3,minmax(260px,1fr));
      padding:14px; max-width:1200px; margin:16px auto 28px;
    }
    @media (max-width:1024px){ main#grid{grid-template-columns:repeat(2,minmax(240px,1fr)); max-width:820px} }
    @media (max-width:640px){  main#grid{grid-template-columns:1fr; max-width:520px} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card);
      border:1px solid var(--bd); border-left-width:6px; border-radius:var(--radius);
      padding:14px; box-shadow: 0 2px 10px rgba(0,0,0,.04);
      transition: transform .18s ease, box-shadow .18s ease, border-color .2s ease;
    }
    .card.ok{ border-left-color:var(--ok) }
    .card.bad{ border-left-color:var(--bad) }
    .card.warn{ border-left-color:var(--warn) }
    .card h2{ margin:0 0 10px; display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
    .rh{width:14px;height:14px; transform:rotate(45deg)}
    .rh.ok{background:var(--ok)} .rh.bad{background:var(--bad)} .rh.warn{background:var(--warn)}
    .chip{display:inline-block; width:18px; height:10px; border-radius:3px}
    .chip.ok{background:var(--ok)} .chip.bad{background:var(--bad)} .chip.na{background:var(--na)}
    .meta{display:grid; row-gap:10px}
    .row{display:flex; justify-content:space-between; align-items:center}
    .label{color:var(--muted); font-size:.9rem}
    .val{display:flex; align-items:center; gap:10px}
    .hr{height:1px; background:var(--hr); margin:8px 0}
    .empty, .error, .loading{ text-align:center; color:var(--muted); padding:16px }

    .site-footer{
      position: sticky; bottom: 0; z-index: 5;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);
      border-top: 1px solid var(--bd);
      padding: 10px 14px;
    }
    .footer-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:10px; color:var(--muted);
    }
    .footer-inner .tag{
      font-weight:700; color:var(--fg); background:rgba(127,127,127,.08);
      border:1px solid var(--bd); padding:4px 8px; border-radius:999px;
    }
    .footer-inner .sep{ opacity:.6 }
    @media (max-width:640px){ .footer-inner{ flex-wrap:wrap; gap:8px } }

    .badges{ display:flex; flex-wrap:wrap; gap:6px; margin: 0 0 8px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:.75rem;
      background:rgba(127,127,127,.08); border:1px solid var(--bd); color:var(--fg);
    }
    .badge code{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.75rem }
    .proto{ opacity:.8 }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>IFE Health Dashboard</h1>
    </div>
    <div class="controls">
      <button id="theme" class="btn" type="button" title="Tema değiştir">
        <svg class="icon" id="themeIcon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 3a9 9 0 1 0 9 9c0-.5 0-1-.1-1.5A6.5 6.5 0 0 1 12 3Z"/>
        </svg>
        Tema
      </button>
      <button id="refresh" class="btn secondary" type="button" aria-label="Şimdi kontrol et">
        <svg class="icon" id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path d="M4 4v6h6M20 20v-6h-6"/><path d="M20 8a8 8 0 1 0 2 6" stroke-width="2"/>
        </svg>
        Kontrol
      </button>
      <a class="btn" href="/static/ip-service.html" title="IP alan cihazları görüntüle">IP-Service</a>
    </div>
  </header>

  <div class="stats" role="status" aria-live="polite">
    <div class="score" id="score" title="Health Score"><span id="scoreVal">–%</span></div>
    <div class="pill"><span class="dot wardot"></span>Toplam: <strong id="statTotal">0</strong></div>
    <div class="pill"><span class="dot okdot"></span>OK: <strong id="statOk">0</strong></div>
    <div class="pill"><span class="dot baddot"></span>Hata: <strong id="statBad">0</strong></div>
    <div class="pill"><span class="dot wardot"></span><span id="pollState">Polling açık</span></div>
  </div>

  <div id="loading" class="loading">Yükleniyor…</div>
  <main id="grid" aria-live="polite"></main>

  <footer class="site-footer">
    <div class="footer-inner">
      <span class="tag">@TCI.DevOps Team</span>
      <span aria-hidden="true">•</span>
      <span id="footMsg">Refreshes Every 5 Seconds</span>
      <span class="sep" aria-hidden="true">•</span>
      <span class="muted">Last refresh: <time id="lastRestart">–:–:–</time></span>
    </div>
  </footer>

  <script type="module">
    // Basit ayarlar
    const CONFIG = {
      POLL_MS: 5000,
      HEALTH_URL: '/api/health',
      SYSTEMD_URL: '/api/system-services',
    };

    const SERVICE_META = window.SERVICE_META || {};

    // Küçük yardımcı fonksiyonlar
    function createEl(tag, attrs = {}, children = []) {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (v == null) continue;
        if (k === 'className') node.className = v;
        else if (k in node) node[k] = v;
        else node.setAttribute(k, String(v));
      }
      if (!Array.isArray(children)) children = [children];
      for (const ch of children) {
        if (ch == null) continue;
        node.append(ch instanceof Node ? ch : document.createTextNode(String(ch)));
      }
      return node;
    }

    const chip = (cls, title) =>
      createEl('span', { className: `chip ${cls}`, title: title || '' });

    const chipBool = (val) => {
      if (val === true) return chip('ok', 'OK');
      if (val === false) return chip('bad', 'Hata');
      return chip('na', 'NA');
    };

    const rh = (state) =>
      createEl('span', { className: `rh ${state}` });

    function httpApplicable(obj) {
      return 'http_ok' in obj || 'status' in obj || 'error' in obj || 'http_path' in obj;
    }

    function isHealthy(obj) {
      const presentOk = obj.present === true;
      const portOk = obj.port_ok === true;
      const httpOk = httpApplicable(obj) ? obj.http_ok === true : true;
      return presentOk && portOk && httpOk;
    }

    function stateClass(obj) {
      return isHealthy(obj) ? 'ok' : 'bad';
    }

    // Port / host / path rozetleri
    function makeBadges(name, obj) {
      const meta = { ...(SERVICE_META[name] || {}), ...(obj || {}) };
      const proto =
        'http_path' in meta || 'expect_status' in meta || 'http_ok' in meta
          ? 'HTTP'
          : 'TCP';
      const items = [];

      if (meta.port != null) {
        items.push(
          createEl('span', { className: 'badge' }, [
            createEl('span', { className: 'proto', textContent: proto }),
            createEl('span', { textContent: ':' }),
            createEl('code', { textContent: String(meta.port) }),
          ]),
        );
      }
      if (meta.host) {
        items.push(
          createEl('span', { className: 'badge' }, [
            createEl('span', { className: 'proto', textContent: 'HOST' }),
            createEl('span', { textContent: ':' }),
            createEl('code', { textContent: String(meta.host) }),
          ]),
        );
      }
      if (proto === 'HTTP' && meta.http_path) {
        items.push(
          createEl('span', { className: 'badge' }, [
            createEl('span', { className: 'proto', textContent: 'PATH' }),
            createEl('span', { textContent: ':' }),
            createEl('code', { textContent: String(meta.http_path) }),
          ]),
        );
      }

      return items.length
        ? createEl('div', { className: 'badges' }, items)
        : null;
    }

    function makeRow(label, valueNode) {
      return createEl('div', { className: 'row' }, [
        createEl('span', { className: 'label', textContent: label }),
        createEl('span', { className: 'val' }, valueNode),
      ]);
    }

    function makeDivider() {
      return createEl('div', { className: 'hr' });
    }

    // Systemd map: { BIND9: {state:'up'}, ... }
    function buildSystemdMap(list) {
      const map = {};
      if (Array.isArray(list)) {
        for (const item of list) {
          const key = (item.id || '').toUpperCase();
          if (key) map[key] = item;
        }
      }
      return map;
    }

    // Kart üretimi
    function makeCard(name, obj, systemdMap) {
      const merged = { ...(SERVICE_META[name] || {}), ...(obj || {}) };
      const cls = stateClass(merged);
      const section = createEl('section', {
        className: `card ${cls}`,
        tabindex: 0,
      });

      const title = createEl('h2', {}, [
        createEl('span', { textContent: name.toUpperCase() }),
        rh(cls),
      ]);

      const badges = makeBadges(name, merged);

      const rows = [];

      rows.push(makeRow('Present', chipBool(merged.present)));
      rows.push(makeRow('Port', chipBool(merged.port_ok)));

      if (httpApplicable(merged)) {
        rows.push(makeRow('HTTP', chipBool(merged.http_ok)));
      }

      // Systemd satırı sadece BIND9/NGINX/KEA/DOCKER için
      const upper = name.toUpperCase();
      if (['BIND9', 'NGINX', 'KEA', 'DOCKER'].includes(upper)) {
        const sys = systemdMap[upper];
        if (sys && sys.state) {
          const st = sys.state; // up/down/unknown
          const chipCls = st === 'up' ? 'ok' : st === 'down' ? 'bad' : 'na';
          rows.push(makeRow('Systemd', chip(chipCls, st)));
        }
      }

      rows.push(makeDivider());

      const portErr = Boolean(merged?.errors?.port);
      const httpErr = Boolean(merged?.errors?.http);

      rows.push(makeRow('Port Hatası', chip(portErr ? 'bad' : 'ok', portErr ? 'Hata' : 'Yok')));
      if (httpApplicable(merged)) {
        rows.push(makeRow('HTTP Hatası', chip(httpErr ? 'bad' : 'ok', httpErr ? 'Hata' : 'Yok')));
      }

      const meta = createEl('div', { className: 'meta' }, rows);

      section.append(title);
      if (badges) section.append(badges);
      section.append(meta);

      return section;
    }

    // DOM referansları
    const gridEl = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');
    const statTotal = document.getElementById('statTotal');
    const statOk = document.getElementById('statOk');
    const statBad = document.getElementById('statBad');
    const scoreEl = document.getElementById('score');
    const scoreVal = document.getElementById('scoreVal');
    const pollStateEl = document.getElementById('pollState');
    const lastRestartEl = document.getElementById('lastRestart');

    let pollId = null;

    function setLoading(on) {
      loadingEl.style.display = on ? 'block' : 'none';
    }

    function updateStats(objs) {
      const total = objs.length;
      const okCount = objs.filter(isHealthy).length;
      const badCount = total - okCount;
      const score = total ? Math.round((okCount / total) * 100) : 0;

      statTotal.textContent = total;
      statOk.textContent = okCount;
      statBad.textContent = badCount;
      scoreEl.style.setProperty('--p', score);
      scoreVal.textContent = `${score}%`;
    }

    async function loadOnce() {
      try {
        setLoading(true);
        gridEl.innerHTML = '';

        const [healthData, systemdList] = await Promise.all([
          fetch(CONFIG.HEALTH_URL).then(r => r.json()),
          fetch(CONFIG.SYSTEMD_URL).then(r => r.json()).catch(() => []),
        ]);

        const systemdMap = buildSystemdMap(systemdList);
        const entries = Object.entries(healthData);
        const cards = [];

        for (const [name, obj] of entries) {
          cards.push(makeCard(name, obj, systemdMap));
        }

        gridEl.replaceChildren(...cards);
        updateStats(entries.map(([, o]) => o));

        if (lastRestartEl) {
          lastRestartEl.textContent = new Date().toLocaleTimeString('tr-TR', { hour12: false });
        }
      } catch (err) {
        console.error(err);
        gridEl.textContent = 'API hatası: ' + err.message;
      } finally {
        setLoading(false);
      }
    }

    function startPolling() {
      if (pollId) return;
      pollId = setInterval(loadOnce, CONFIG.POLL_MS);
      pollStateEl.textContent = 'Polling açık';
    }

    function stopPolling() {
      if (!pollId) return;
      clearInterval(pollId);
      pollId = null;
      pollStateEl.textContent = 'Polling kapalı';
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopPolling();
      else startPolling();
    });

    // Refresh butonu
    const refreshBtn = document.getElementById('refresh');
    const refreshIcon = document.getElementById('refreshIcon');
    refreshBtn.addEventListener('click', async () => {
      refreshIcon.classList.add('spin');
      await loadOnce();
      refreshIcon.classList.remove('spin');
    });

    // Basit tema butonu (dark / light toggle)
    const themeBtn = document.getElementById('theme');
    const themeIcon = document.getElementById('themeIcon');
    const THEME_KEY = 'ife.theme.simple';

    function applyTheme(mode) {
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem(THEME_KEY, mode);
      themeBtn.title = `Tema: ${mode}`;
      const color = mode === 'light' ? '#f7f9fc' : '#0b1220';
      document.getElementById('themeColor').setAttribute('content', color);
      // ikon çok önemli değil, default dursun
    }

    function toggleTheme() {
      const current = localStorage.getItem(THEME_KEY) || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    }

    themeBtn.addEventListener('click', toggleTheme);
    applyTheme(localStorage.getItem(THEME_KEY) || 'dark');

    // İlk yükleme
    await loadOnce();
    startPolling();
  </script>
</body>
</html>
