<!DOCTYPE html>
<html lang="tr" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFE Health Dashboard</title>
  
<script>window.SERVICE_META = window.SERVICE_META || { bind9:{http:false}, nats_client:{http:false} };</script>
  <meta id="themeColor" name="theme-color" content="#0b1220">
  <style>
    /* -----------------------------
       Tema Değişkenleri
    ------------------------------*/
    :root{
      --bg:#0b1220; --fg:#e8edf7; --muted:#9aa6b2;
      --card:#0f172a; --bd:#1f2a44; --hr:#1c253f; --na:#324158;
      --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --brand1:#2563eb; --brand2:#22d3ee; --brand3:#a78bfa;
      --glow: 0 10px 30px -10px rgba(34,211,238,.35), 0 6px 18px -8px rgba(39,92,211,.35);
      --radius:14px; --focus: 0 0 0 3px rgba(34,211,238,.5);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f9fc; --fg:#0f172a; --muted:#6b7280;
        --card:#ffffff; --bd:#e6ecf5; --hr:#eef2f7; --na:#d1d5db;
        --glow: 0 10px 30px -10px rgba(34,197,94,.25), 0 6px 18px -8px rgba(59,130,246,.25);
      }
    }
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"]{  color-scheme: dark;  }
    :root[data-theme="light"]{
      --bg:#f7f9fc; --fg:#0f172a; --muted:#6b7280;
      --card:#ffffff; --bd:#e6ecf5; --hr:#eef2f7; --na:#d1d5db;
      --glow: 0 10px 30px -10px rgba(34,197,94,.25), 0 6px 18px -8px rgba(59,130,246,.25);
    }
    :root[data-theme="dark"]{
      --bg:#0b1220; --fg:#e8edf7; --muted:#9aa6b2;
      --card:#0f172a; --bd:#1f2a44; --hr:#1c253f; --na:#324158;
    }

    /* -----------------------------
       Reset / Genel
    ------------------------------*/
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(800px 600px at 110% 10%, rgba(167,139,250,.12), transparent 60%),
        var(--bg);
      color:var(--fg);
      letter-spacing:.1px;
    }
    a{color:inherit}
    :focus-visible{outline:none; box-shadow:var(--focus); border-radius:10px}

    /* -----------------------------
       Header
    ------------------------------*/
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(140%) blur(10px);
      background: linear-gradient(90deg, rgba(37,99,235,.85), rgba(59,130,246,.85)) border-box;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:#fff;
      padding:14px 18px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:28px; height:28px; border-radius:9px;
      background: conic-gradient(from 210deg, var(--brand1), var(--brand2), var(--brand3), var(--brand1));
      box-shadow: var(--glow);
    }
    header h1{margin:0; font-size:1.05rem; letter-spacing:.3px}
    .controls{ display:flex; flex-wrap:wrap; gap:8px; justify-self:end; }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.12);
      color:#fff; padding:8px 12px; border-radius:10px; font-weight:600;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover{transform: translateY(-1px); background:rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0)}
    .btn.secondary{background:#fff; color:#2563eb; border-color:transparent}
    .icon{width:16px;height:16px; display:inline-block}
    .search{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
      background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25);
      color:#fff; min-width:200px;
    }
    .search input{ all:unset; width:180px; color:inherit; }

    /* -----------------------------
       Stat bar
    ------------------------------*/
    .stats{
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      padding:10px 18px; border-bottom:1px solid var(--hr);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
    }
    .pill{
      display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      background:var(--card); border:1px solid var(--bd); color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:3px}
    .okdot{background:var(--ok)} .baddot{background:var(--bad)} .wardot{background:var(--warn)}
    .score{
      --p: 65;
      position:relative; width:54px; height:54px; border-radius:50%;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), rgba(127,140,160,.25) 0);
      display:grid; place-items:center; color:#fff; font-weight:700; font-size:.8rem;
      border:1px solid var(--bd); box-shadow: var(--glow);
    }
    .score::after{ content:""; position:absolute; inset:6px; border-radius:50%; background:var(--card); }
    .score span{position:relative; z-index:1; color:var(--fg)}

    /* -----------------------------
       Grid & Kartlar
    ------------------------------*/
    main#grid{
      display:grid; gap:14px; grid-template-columns:repeat(3,minmax(260px,1fr));
      padding:14px; max-width:1200px; margin:16px auto 28px;
    }
    @media (max-width:1024px){ main#grid{grid-template-columns:repeat(2,minmax(240px,1fr)); max-width:820px} }
    @media (max-width:640px){  main#grid{grid-template-columns:1fr; max-width:520px} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card);
      border:1px solid var(--bd); border-left-width:6px; border-radius:var(--radius);
      padding:14px; box-shadow: 0 2px 10px rgba(0,0,0,.04);
      transition: transform .18s ease, box-shadow .18s ease, border-color .2s ease;
      will-change: transform;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--glow) }
    .card.ok{ border-left-color:var(--ok) }
    .card.bad{ border-left-color:var(--bad) }
    .card.warn{ border-left-color:var(--warn) }
    .card h2{ margin:0 0 10px; display:flex; justify-content:space-between; align-items:center; font-size:1rem; }
    .rh{width:14px;height:14px; transform:rotate(45deg)}
    .rh.ok{background:var(--ok)} .rh.bad{background:var(--bad)} .rh.warn{background:var(--warn)}
    .chip{display:inline-block; width:18px; height:10px; border-radius:3px}
    .chip.ok{background:var(--ok)} .chip.bad{background:var(--bad)} .chip.na{background:var(--na)}
    .meta{display:grid; row-gap:10px}
    .row{display:flex; justify-content:space-between; align-items:center}
    .label{color:var(--muted); font-size:.9rem}
    .val{display:flex; align-items:center; gap:10px}
    .hr{height:1px; background:var(--hr); margin:8px 0}
    .empty, .error, .loading{ text-align:center; color:var(--muted); padding:16px }

    /* Skeleton */
    .skeleton{ border-left-color:transparent; position:relative; overflow:hidden; }
    .shine{ position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.06), transparent);
      transform: translateX(-100%); animation: shine 1.2s linear infinite; }
    @keyframes shine{ to{ transform: translateX(100%) } }

    /* Refresh dönen ikon */
    .spin{ animation: spin .9s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    @media (prefers-reduced-motion: reduce){
      .btn, .card{ transition:none }
      .shine, .spin{ animation: none }
    }

    /* -----------------------------
       Footer
    ------------------------------*/
    .site-footer{
      position: sticky; bottom: 0; z-index: 5;
      backdrop-filter: saturate(140%) blur(8px);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);
      border-top: 1px solid var(--bd);
      padding: 10px 14px;
    }
    .footer-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:10px; color:var(--muted);
    }
    .footer-inner .tag{
      font-weight:700; color:var(--fg); background:rgba(127,127,127,.08);
      border:1px solid var(--bd); padding:4px 8px; border-radius:999px;
    }
    .footer-inner .sep{ opacity:.6 }
    @media (max-width:640px){ .footer-inner{ flex-wrap:wrap; gap:8px } }

    /* -----------------------------
       Port Rozetleri
    ------------------------------*/
    .badges{ display:flex; flex-wrap:wrap; gap:6px; margin: 0 0 8px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:.75rem;
      background:rgba(127,127,127,.08); border:1px solid var(--bd); color:var(--fg);
    }
    .badge code{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.75rem }
    .proto{ opacity:.8 }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>IFE Health Dashboard</h1>
    </div>
    <div class="controls">
      <label class="search" aria-label="Servis ara">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><circle cx="11" cy="11" r="7" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke-width="2"/></svg>
        <input id="filter" type="search" placeholder="Servis ara…" autocomplete="off"/>
      </label>
      <button id="sort" class="btn" type="button" aria-pressed="false" title="Sağlıklı olanları başa al">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M7 4v13m0 0-3-3m3 3 3-3M17 20V7m0 0-3 3m3-3 3 3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Sırala
      </button>
      <button id="theme" class="btn" type="button" title="Tema: auto">
        <svg class="icon" id="themeIcon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3a9 9 0 1 0 9 9c0-.5 0-1-.1-1.5A6.5 6.5 0 0 1 12 3Z"/></svg>
        Tema
      </button>
      <button id="refresh" class="btn secondary" type="button" aria-label="Şimdi kontrol et">
        <svg class="icon" id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M4 4v6h6M20 20v-6h-6"/><path d="M20 8a 8 8 0 1 0 2 6" stroke-width="2"/></svg>
        Kontrol
      </button>

        <a class="btn" href="/static/ip-service.html" title="IP alan cihazları görüntüle">IP-Service</a>

    </div>
  </header>

  <div class="stats" role="status" aria-live="polite">
    <div class="score" id="score" title="Health Score"><span id="scoreVal">–%</span></div>
    <div class="pill" title="Toplam servis"><span class="dot wardot"></span>Toplam: <strong id="statTotal">0</strong></div>
    <div class="pill" title="Sağlıklı"><span class="dot okdot"></span>OK: <strong id="statOk">0</strong></div>
    <div class="pill" title="Sorunlu"><span class="dot baddot"></span>Hata: <strong id="statBad">0</strong></div>
    <div class="pill" title="Otomatik yenileme"><span class="dot wardot"></span><span id="pollState">Polling açık</span></div>
  </div>

  <div id="loading" class="loading" role="status" aria-live="polite">Yükleniyor…</div>
  <main id="grid" aria-live="polite"></main>

  <footer class="site-footer" role="contentinfo">
    <div class="footer-inner">
      <span class="tag">@TCI.DevOps Team</span>
      <span aria-hidden="true">•</span>
      <span id="footMsg">Refreshes Every 5 Seconds</span>
      <span class="sep" aria-hidden="true">•</span>
      <span class="muted">Last restart: <time id="lastRestart">–:–:–</time></span>
    </div>
  </footer>

  <template id="skeletonCard">
    <section class="card skeleton" aria-hidden="true">
      <div class="shine"></div>
      <h2>
        <span style="width:40%;height:14px;background:var(--hr);border-radius:6px;display:inline-block"></span>
        <span class="rh ok"></span>
      </h2>
      <div class="meta">
        <div class="row"><span class="label">Present</span><span class="val"><span class="chip na"></span></span></div>
        <div class="row"><span class="label">Port</span><span class="val"><span class="chip na"></span></span></div>
        <div class="row"><span class="label">HTTP</span><span class="val"><span class="chip na"></span></span></div>
        <div class="hr"></div>
        <div class="row"><span class="label">Port Hatası</span><span class="val"><span class="chip na"></span></span></div>
        <div class="row"><span class="label">HTTP Hatası</span><span class="val"><span class="chip na"></span></span></div>
      </div>
    </section>
  </template>

  <script type="module">
    // --------------------
    // Sabitler ve yardımcılar
    // --------------------
    const CONFIG = Object.freeze({
      POLL_MS: 5000,
      ENDPOINTS: Object.freeze({ HEALTH: '/api/health', RUN: '/api/run' }),
      LABELS: Object.freeze({
        present: 'Present',
        port: 'Port',
        http: 'HTTP',
        portErr: 'Port Hatası',
        httpErr: 'HTTP Hatası'
      })
    });

    /** Element yaratıcı */
    const el = (tag, attrs = {}, children = []) => {
      const node = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (v == null) continue;
        if (k === 'className') node.className = v;
        else if (k === 'dataset') Object.assign(node.dataset, v);
        else if (k in node) node[k] = v;
        else node.setAttribute(k, String(v));
      }
      if (!Array.isArray(children)) children = [children];
      for (const child of children) {
        if (child == null) continue;
        node.append(child instanceof Node ? child : document.createTextNode(String(child)));
      }
      return node;
    };

    const chip = (cls, title) => el('span', {
      className: `chip ${cls}`,
      role: 'img',
      ariaLabel: title || '',
      title: title || ''
    });
    const chipBool = (v) => v === true ? chip('ok','Evet') : v === false ? chip('bad','Hayır') : chip('na','NA');

    const rh = (state) => el('span', {
      className: `rh ${state}`,
      role: 'img',
      ariaLabel: state === 'ok' ? 'Sağlıklı' : state === 'warn' ? 'Uyarı' : 'Sağlıksız',
      title: state === 'ok' ? 'Sağlıklı' : state === 'warn' ? 'Uyarı' : 'Sağlıksız'
    });

    // Sağlık kuralları
    const httpApplicable = (obj) => ('http_ok' in obj) || ('status' in obj) || ('error' in obj) || ('http_path' in obj);
    const isHealthy = (obj) => {
      const presentOk = obj.present === true;
      const portOk = obj.port_ok === true;
      const httpOk = httpApplicable(obj) ? (obj.http_ok === true) : true;
      return presentOk && portOk && httpOk;
    };
    const hasWarning = (obj) => {
      const presentOk = obj.present === true;
      const portOk = obj.port_ok === true;
      const applicable = httpApplicable(obj);
      return presentOk && portOk && applicable && obj.http_ok == null;
    };

    // Ağ
    let currentController = null;
    const fetchJSON = async (url, options = {}) => {
      if (currentController) currentController.abort();
      currentController = new AbortController();
      const { signal } = currentController;
      const res = await fetch(url, { ...options, signal, headers: { 'Accept': 'application/json', ...(options.headers||{}) } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    };
    const api = Object.freeze({
      health: () => fetchJSON(CONFIG.ENDPOINTS.HEALTH),
      run: () => fetchJSON(CONFIG.ENDPOINTS.RUN, { method: 'POST' })
    });

    // --------------------
    // Port / Protokol rozetleri
    // --------------------
const makeBadges = (name, obj) => {
  const meta = { ...(SERVICE_META[name] || {}), ...(obj || {}) };
  const proto = ('http_path' in meta || 'expect_status' in meta || 'http_ok' in meta) ? 'HTTP' : 'TCP';
  const items = [];
  if (meta.port != null) items.push(
    el('span', { className:'badge' }, [ el('span',{className:'proto',textContent:proto}), el('span',{textContent:':'}), el('code',{textContent:String(meta.port)}) ])
  );
  if (meta.host) items.push(
    el('span', { className:'badge' }, [ el('span',{className:'proto',textContent:'HOST'}), el('span',{textContent:':'}), el('code',{textContent:String(meta.host)}) ])
  );
  if (proto === 'HTTP' && meta.http_path){
    items.push(
      el('span', { className:'badge' }, [ el('span',{className:'proto',textContent:'PATH'}), el('span',{textContent:':'}), el('code',{textContent:String(meta.http_path)}) ])
    );
  }
  return items.length ? el('div', { className:'badges' }, items) : null;
};

    // Render parçaları
    const makeRow = (labelText, valueNode) =>
      el('div', { className: 'row' }, [
        el('span', { className: 'label', textContent: labelText }),
        el('span', { className: 'val' }, valueNode)
      ]);
    const makeDivider = () => el('div', { className: 'hr', role: 'separator', ariaHidden: 'true' });
    const stateClass = (obj) => isHealthy(obj) ? 'ok' : hasWarning(obj) ? 'warn' : 'bad';

    const makeCard = (name, obj) => {
      const applicable = httpApplicable(obj);
      const sClass = stateClass(obj);
      const httpIcon = applicable ? chipBool(obj.http_ok) : chip('na','NA');
      const portErr = Boolean(obj?.errors?.port);
      const httpErr = Boolean(obj?.errors?.http);

      const section = el('section', { className: `card ${sClass}`, ariaLabel: `${name} durumu`, tabIndex: 0 });

      const title = el('h2', {}, [
        el('span', { textContent: String(name).toUpperCase() }),
        rh(sClass)
      ]);

      const badges = makeBadges(name, obj);

      // HTTP satırı yalnızca true/false ise gösterilsin (yeşil/kırmızı). NA ise gizle.
      const showHttpRow = obj.http_ok === true || obj.http_ok === false;

      const metaChildren = [
        makeRow(CONFIG.LABELS.present, chipBool(obj.present)),
        makeRow(CONFIG.LABELS.port, chipBool(obj.port_ok)),
        showHttpRow ? makeRow(CONFIG.LABELS.http, httpIcon) : null,
        makeDivider(),
        makeRow(CONFIG.LABELS.portErr, chip(portErr ? 'bad' : 'ok', portErr ? 'Hata' : 'Sorun yok')),
        showHttpRow ? makeRow(CONFIG.LABELS.httpErr, chip(httpErr ? 'bad' : 'ok', httpErr ? 'Hata' : 'Sorun yok')) : null
      ].filter(Boolean);

      const meta = el('div', { className: 'meta' }, metaChildren);

      section.append(title, badges, meta);
      return section;
    };

    const gridEl = document.getElementById('grid');
    const loadingEl = document.getElementById('loading');

    const renderSkeletons = (n = 6) => {
      const frag = document.createDocumentFragment();
      const tpl = document.getElementById('skeletonCard');
      for (let i=0;i<n;i++) frag.append(tpl.content.cloneNode(true));
      gridEl.replaceChildren(frag);
    };

    const render = (data) => {
  // meta ile birleştir
  const entries = Object.entries(data).map(([name, obj]) => [name, { ...(SERVICE_META[name] || {}), ...(obj || {}) }]);

  const filtered = filterQuery.value
    ? entries.filter(([k]) => k.toLowerCase().includes(filterQuery.value.trim().toLowerCase()))
    : entries;

  const list = sortHealthyFirst
    ? filtered.sort(([,a],[,b]) => Number(isHealthy(b)) - Number(isHealthy(a)))
    : filtered;

  const frag = document.createDocumentFragment();
  if (list.length === 0){
    frag.append(el('p', { className: 'empty', textContent: 'Gösterilecek servis bulunamadı.' }));
  } else {
    list.forEach(([name, obj]) => frag.appendChild(makeCard(name, obj)));
  }
  gridEl.replaceChildren(frag);
  updateStats(entries.map(([,o])=>o));
};


    // Stats
    const $total = document.getElementById('statTotal');
    const $ok = document.getElementById('statOk');
    const $bad = document.getElementById('statBad');
    const $score = document.getElementById('score');
    const $scoreVal = document.getElementById('scoreVal');

    const updateStats = (arr) => {
      const total = arr.length;
      const ok = arr.filter(isHealthy).length;
      const bad = arr.filter(o => !isHealthy(o) && !hasWarning(o)).length;
      const score = total ? Math.round((ok / total) * 100) : 0;
      $total.textContent = total;
      $ok.textContent = ok;
      $bad.textContent = bad;
      $score.style.setProperty('--p', score);
      $scoreVal.textContent = `${score}%`;
      $score.title = `Health Score: ${score}%`;
    };

    // --------------------
    // Yükleme / döngü yönetimi
    // --------------------
    let pollId = null;
    let lastData = null;
    const setLoading = (on) => { loadingEl.style.display = on ? 'block' : 'none'; };

    const load = async (opts = { run: false }) => {
      setLoading(true);
      renderSkeletons();
      try {
        const data = opts.run ? await api.run() : await api.health();
        lastData = data;
        render(data);

        // Footer: son restart zamanı (her başarılı yüklemede)
        const $lastRestart = document.getElementById('lastRestart');
        if ($lastRestart) {
          $lastRestart.textContent = new Date().toLocaleTimeString('tr-TR', {hour12:false});
        }
      } catch (err) {
        console.error(err);
        gridEl.replaceChildren(el('p', { className: 'error', textContent: `API hatası: ${err.message}` }));
      } finally {
        setLoading(false);
      }
    };

    const pollState = document.getElementById('pollState');
    const startPolling = () => {
      if (pollId) return;
      pollId = setInterval(() => load(), CONFIG.POLL_MS);
      pollState.textContent = 'Polling açık';
    };
    const stopPolling = () => {
      if (!pollId) return;
      clearInterval(pollId); pollId = null;
      pollState.textContent = 'Polling kapalı';
    };
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) { stopPolling(); }
      else { startPolling(); }
    });

    // --------------------
    // UI etkileşimleri
    // --------------------
    const refreshBtn = document.getElementById('refresh');
    const refreshIcon = document.getElementById('refreshIcon');
    refreshBtn.addEventListener('click', async () => {
      refreshIcon.classList.add('spin');
      await load({ run: true }).finally(() => refreshIcon.classList.remove('spin'));
    });

    const filterQuery = document.getElementById('filter');
    let sortHealthyFirst = false;
    filterQuery.addEventListener('input', () => { if (lastData) render(lastData); });

    const sortBtn = document.getElementById('sort');
    sortBtn.addEventListener('click', () => {
      sortHealthyFirst = !sortHealthyFirst;
      sortBtn.setAttribute('aria-pressed', String(sortHealthyFirst));
      if (lastData) render(lastData);
    });

    // --------------------
    // Tema yönetimi (3 mod: auto / light / dark)
    // --------------------
    const themeBtn  = document.getElementById('theme');
    const themeIcon = document.getElementById('themeIcon');
    const THEME_KEY = 'ife.theme';

    const setThemeMetaColor = (mode) => {
      const prefersLight = matchMedia('(prefers-color-scheme: light)').matches;
      const color = mode === 'light' ? '#f7f9fc'
                  : mode === 'dark'  ? '#0b1220'
                                      : (prefersLight ? '#f7f9fc' : '#0b1220');
      document.getElementById('themeColor').setAttribute('content', color);
    };

    const setTheme = (mode) => {
      document.documentElement.setAttribute('data-theme', mode);
      localStorage.setItem(THEME_KEY, mode);
      themeBtn.title = `Tema: ${mode}`;
      themeIcon.innerHTML = ({
        auto:'<path d="M12 3a9 9 0 1 0 9 9c0-.5 0-1-.1-1.5A6.5 6.5 0 0 1 12 3Z"/>',
        light:'<circle cx="12" cy="12" r="5"></circle><g stroke="currentColor" fill="none" stroke-width="2"><path d="M12 1v3"/><path d="M12 20v3"/><path d="M4.2 4.2l2.1 2.1"/><path d="M17.7 17.7l2.1 2.1"/><path d="M1 12h3"/><path d="M20 12h3"/><path d="M4.2 19.8l2.1-2.1"/><path d="M17.7 6.3l2.1-2.1"/></g>',
        dark:'<path d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 1 0 9.8 9.8Z"></path>'
      })[mode];
      setThemeMetaColor(mode);
    };

    const cycleTheme = () => {
      const current = localStorage.getItem(THEME_KEY) || 'auto';
      const next = current === 'auto' ? 'light' : current === 'light' ? 'dark' : 'auto';
      setTheme(next);
    };

    themeBtn.addEventListener('click', cycleTheme);
    setTheme(localStorage.getItem(THEME_KEY) || 'auto');

    // İlk yükleme
    await load();
    startPolling();
  </script>
</body>
</html>
