<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFE Control Dashboard</title>

  <script>
    window.SERVICE_META = window.SERVICE_META || {
      bind9:      { http: false },
      nats_client:{ http: false },
    };
  </script>

  <meta id="themeColor" name="theme-color" content="#020617">

  <style>
    /* -----------------------------
       Tek koyu tema
    ------------------------------*/
    :root {
      --bg:#020617;
      --fg:#e5edf7;
      --muted:#9aa6b2;

      --card:#020f2b;
      --bd:#1f2a44;
      --hr:#111827;
      --na:#324158;

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --brand1:#2563eb;
      --brand2:#22d3ee;
      --brand3:#4f46e5;

      --glow: 0 10px 30px -10px rgba(34,211,238,.35),
               0 6px 18px -8px rgba(37,99,235,.35);

      --radius:14px;
      --focus: 0 0 0 3px rgba(34,211,238,.5);

      --footer-h:56px;
    }

    /* -----------------------------
       Reset / Genel
    ------------------------------*/
    *{box-sizing:border-box}
    html,body{height:100%}

    html{
      background: var(--bg);
    }

body{
  margin:0;
  font: 15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
  background:
    radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.25), transparent 60%),
    radial-gradient(900px 700px at 110% 10%, rgba(79,70,229,.20), transparent 60%),
    var(--bg);
  background-attachment: fixed;
  color:var(--fg);
  letter-spacing:.1px;

  display:flex;
  flex-direction:column;
  min-height:100vh;
}



    a{color:inherit; text-decoration:none}
    :focus-visible{outline:none; box-shadow:var(--focus); border-radius:10px}

    /* -----------------------------
       Header
    ------------------------------*/
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(140%) blur(12px);
      background:
        linear-gradient(90deg, rgba(15,23,42,.85), rgba(30,64,175,.96)) border-box;
      border-bottom:1px solid rgba(15,23,42,.85);
      color:#fff;
      padding:14px 18px;
      display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:28px; height:28px; border-radius:9px;
      background: conic-gradient(from 210deg, var(--brand1), var(--brand2), var(--brand3), var(--brand1));
      box-shadow: var(--glow);
    }
    header h1{margin:0; font-size:1.05rem; letter-spacing:.3px}
    .controls{ display:flex; flex-wrap:wrap; gap:8px; justify-self:end; }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(15,23,42,.4);
      color:#fff; padding:8px 12px; border-radius:10px; font-weight:600;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      background:rgba(15,23,42,.7);
      box-shadow:0 10px 25px rgba(0,0,0,.35);
    }
    .btn:active{transform: translateY(0); box-shadow:none}
    .btn.secondary{
      background:#eff6ff;
      color:#1d4ed8;
      border-color:rgba(191,219,254,1);
    }
    .btn.secondary:hover{
      background:#dbeafe;
    }
    .icon{width:16px;height:16px; display:inline-block}

    /* -----------------------------
       Stats Bar
    ------------------------------*/
    .stats{
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      padding:10px 18px;
      border-bottom:1px solid var(--hr);
      background: linear-gradient(180deg,
        rgba(15,23,42,.92),
        rgba(15,23,42,.96));
    }
   .pill {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 10px;
  border-radius: 999px;
  border: 1px solid var(--bd);
  background: rgba(15,23,42,0.9);
  font-size: 12px;
  color: var(--muted);
  white-space: nowrap;
}
    .dot{width:10px;height:10px;border-radius:3px}
    .okdot{background:var(--ok)} .baddot{background:var(--bad)} .wardot{background:var(--warn)}
    .score{
      --p: 65;
      position:relative; width:54px; height:54px; border-radius:50%;
      background: conic-gradient(var(--ok) calc(var(--p) * 1%), rgba(30,64,175,.55) 0);
      display:grid; place-items:center; color:#fff; font-weight:700; font-size:.8rem;
      border:1px solid var(--bd); box-shadow: var(--glow);
    }
    .score::after{
      content:"";
      position:absolute; inset:6px; border-radius:50%;
      background:radial-gradient(circle at 30% 0, rgba(59,130,246,.35), transparent 55%), #020617;
    }
    .score span{position:relative; z-index:1; color:var(--fg)}

    .stats {
  display: flex;
  align-items: center;
  gap: 8px;
}

.pill-kernel {
  margin-left: auto;          
  font-size: 12px;
  opacity: 0.85;
}
.pill-distro {
  opacity: 0.9;
}


    /* -----------------------------
       Search bar
    ------------------------------*/
    .toolbar{
      padding:8px 18px 0;
    }
    .toolbar-inner{
      max-width:1200px;
      margin:0 auto;
    }
    .search{
      position:relative;
      display:block;
      max-width:320px;
    }
    .search-input{
      width:100%;
      padding:8px 10px 8px 30px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:rgba(15,23,42,.9);
      color:var(--fg);
      font-size:.9rem;
      outline:none;
      box-shadow:0 0 0 1px rgba(15,23,42,.9);
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .search-input::placeholder{
      color:rgba(148,163,184,.8);
    }
    .search-input:focus-visible{
      border-color:var(--brand2);
      box-shadow:0 0 0 1px rgba(56,189,248,.7);
      background:#020617;
    }
    .search-icon{
      position:absolute;
      left:9px;
      top:50%;
      transform:translateY(-50%);
      width:14px;
      height:14px;
      color:rgba(148,163,184,.9);
      pointer-events:none;
    }

    /* -----------------------------
       Ana içerik + Gruplar
    ------------------------------*/
    main#grid{
      padding:10px 14px 0;
      max-width:1420px; 
      margin:8px auto 32px;  
      flex:1 0 auto;         
    }

    .group{
      margin-bottom:18px;
      padding: 16px;
    }
    .group-title{
      font-size:.9rem;
      font-weight:600;
      color:var(--muted);
      margin:4px 2px 8px;
      text-transform:uppercase;
      letter-spacing:.08em;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .group-title::before{
      content:"";
      width:6px; height:6px;
      border-radius:999px;
      background:linear-gradient(135deg,var(--brand1),var(--brand2));
      box-shadow:0 0 0 3px rgba(37,99,235,.4);
    }

    .group-cards{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(4,minmax(260px,1fr));
    }

    .docker-cards{
       grid-template-columns: repeat(4,minmax(260px,1fr));
    }

    @media (max-width:1024px){
      .group-cards{
        grid-template-columns:repeat(2,minmax(240px,1fr));
        max-width:820px;
      }
      .docker-cards{
        grid-template-columns:1fr;
        max-width:100%;
      }
    }
    @media (max-width:640px){
      .group-cards{
        grid-template-columns:1fr;
        max-width:520px;
      }
      .docker-cards{
        grid-template-columns:1fr;
        max-width:100%;
      }
    }

    /* -----------------------------
       Kart
    ------------------------------*/
    .card{
      background:
        radial-gradient(circle at 0 0, rgba(37,99,235,.25), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(96,165,250,.20), transparent 55%),
        var(--card);
      border:1px solid var(--bd); border-left-width:6px; border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 4px 18px rgba(0,0,0,.45);
      transition: transform .18s ease, box-shadow .18s ease, border-color .2s ease, background .2s ease;
      display:flex; 
      flex-direction:column;
      height: 100%;
    }
    .card.ok{ border-left-color:var(--ok) }
    .card.bad{ border-left-color:var(--bad) }
    .card.is-stopping{
      opacity: .7;
      pointer-events: none;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 32px rgba(0,0,0,.65);
      border-color:rgba(59,130,246,.75);
      background:
        radial-gradient(circle at 0 0, rgba(59,130,246,.45), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(37,99,235,.35), transparent 60%),
        var(--card);
    }
    .card h2{
      margin:0 0 10px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:1rem;
    }
    .rh{width:14px;height:14px; transform:rotate(45deg)}
    .rh.ok{background:var(--ok)} .rh.bad{background:var(--bad)} .rh.warn{background:var(--warn)}
    .chip{display:inline-block; width:18px; height:10px; border-radius:3px}
    .chip.ok{background:var(--ok)} .chip.bad{background:var(--bad)} .chip.na{background:var(--na)}
    .meta{display:grid; row-gap:10px}
    .row{display:flex; justify-content:space-between; align-items:center}
    .label{color:var(--muted); font-size:.9rem}
    .val{display:flex; align-items:center; gap:10px}
    .status-text{color:var(--muted); font-size:.85rem}

    .hr{height:1px; background:var(--hr); margin:8px 0}
    .empty, .error, .loading{ text-align:center; color:var(--muted); padding:16px }
    
    .card-footer{
      margin-top:auto;
      padding-top:10px;
      border-top:1px solid var(--hr);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .card-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      width:100%;
    }
    .btn.card-action{
      padding:6px 10px;
      font-size:.8rem;
      border-radius:8px;
    }
    .btn.card-action.danger{
      border-color:rgba(239,68,68,.6);
      color:#fecaca;
    }
    .btn.card-action.info{
      border-color:rgba(56,189,248,.6);
      color:#bae6fd;
    }


    .badges{ display:flex; flex-wrap:wrap; gap:6px; margin: 0 0 8px; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font-size:.75rem;
      background:rgba(15,23,42,.9); border:1px solid var(--bd); color:var(--fg);
    }
    .badge code{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:.75rem }
    .proto{ opacity:.8 }


    /* -----------------------------
       Footer
    ------------------------------*/
.site-footer{
  margin-top:auto;

  display: flex;
  align-items: center;
  backdrop-filter: saturate(140%) blur(8px);
  background: linear-gradient(180deg,
    rgba(15,23,42,.92),
    rgba(15,23,42,.98));
  border-top: 1px solid var(--bd);
  padding: 10px 14px;
}

    .footer-inner{
      max-width:1200px; margin:0 auto;
      display:flex; align-items:center; gap:10px; color:var(--muted);
      font-size:.85rem;
    }
    .footer-inner .tag{
      font-weight:700; color:var(--fg); background:rgba(15,23,42,.9);
      border:1px solid var(--bd); padding:4px 8px; border-radius:999px;
    }
    .footer-inner .sep{ opacity:.6 }
    @media (max-width:640px){ .footer-inner{ flex-wrap:wrap; gap:8px } }

    /* Refresh icon animasyonu */
    .spin{
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>IFE Control Dashboard</h1>
    </div>
    <div class="controls">
      <button id="refresh" class="btn secondary" type="button" aria-label="Şimdi kontrol et">
        <svg class="icon" id="refreshIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <path d="M4 4v6h6M20 20v-6h-6"/><path d="M20 8a8 8 0 1 0 2 6" stroke-width="2"/>
        </svg>
        Kontrol
      </button>
      <a class="btn" href="/static/ip-service.html" title="IP alan cihazları görüntüle">IP-Service</a>
      <a class="btn" href="/static/logs-service.html" title="Container loglarını görüntüle"> Logs-Service </a>
      <a class="btn" href="/static/deployct-service.html" title="Jenkins deploy raporu">DeployCT-Service</a>    </div>

  </header>

<div class="stats" role="status" aria-live="polite">
  <div class="score" id="score" title="Health Score">
    <span id="scoreVal">–%</span>
  </div>

  <div class="pill">
    <span class="dot wardot"></span>
    Toplam: <strong id="statTotal">0</strong>
  </div>

  <div class="pill">
    <span class="dot okdot"></span>
    OK: <strong id="statOk">0</strong>
  </div>

  <div class="pill">
    <span class="dot baddot"></span>
    Hata: <strong id="statBad">0</strong>
  </div>

  <div class="pill pill-kernel" title="Linux kernel sürümü">
    Kernel Versiyon: <strong id="kernelText">...</strong>
  </div>

  <div class="pill pill-distro" title="Linux dağıtımı">
    <strong id="distroText">...</strong>
  </div>
</div>



  <div class="toolbar">
    <div class="toolbar-inner">
      <label class="search">
        <svg class="search-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M10.5 4a6.5 6.5 0 0 1 5.18 10.47l3.43 3.42a1 1 0 0 1-1.42 1.42l-3.42-3.43A6.5 6.5 0 1 1 10.5 4Zm0 2a4.5 4.5 0 1 0 0 9a4.5 4.5 0 0 0 0-9Z"/>
        </svg>
        <input id="search" class="search-input" type="search" placeholder="Servis ara..." autocomplete="off" />
      </label>
    </div>
  </div>

  <div id="loading" class="loading"></div>
  <main id="grid" aria-live="polite"></main>

  <footer class="site-footer">
    <div class="footer-inner">
      <span class="tag">@TCI.DevOps Team</span>
    </div>
  </footer>

  <script type="module">
  const CONFIG = {
    SYSTEMD_URL: '/api/system-services',
    DOCKER_URL: '/api/docker-services',
    HEALTH_URL: '/api/health',
    STATIC_SYSTEMD_IDS: ['bind9', 'kea', 'nginx', 'system-service'],
  };

  // ---------- Mini yardımcılar ----------
  function el(tag, attrs = {}, children = []) {
    const node = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (v == null) continue;
      if (k === 'className') node.className = v;
      else if (k in node) node[k] = v;
      else node.setAttribute(k, String(v));
    }
    if (!Array.isArray(children)) children = [children];
    for (const c of children) {
      if (c == null) continue;
      node.append(c instanceof Node ? c : document.createTextNode(String(c)));
    }
    return node;
  }

  const chip = (cls, title) =>
    el('span', { className: `chip ${cls}`, title: title || '' });

  const rh = (state) => el('span', { className: `rh ${state}` });

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { Accept: 'application/json' } });
    if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
    return res.json();
  }
  // Docker action POST isteği
  async function postDockerAction(containerName, action) {
    const res = await fetch(
      `/api/docker-services/${encodeURIComponent(containerName)}/${action}`,
      { method: 'POST' },
    );
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || `Docker ${action} hatası`);
    }
    return res.json().catch(() => ({}));
  }

  // ---------- Global durum ----------
  let healthVersions = {};   // /api/health -> name -> version
  let staticServices = [];
  let dynamicServices = [];

  // ---------- Normalizasyon ----------
  function normalizeSystemd(item) {
    const id = (item.id || '').toLowerCase();
    if (!CONFIG.STATIC_SYSTEMD_IDS.includes(id)) return null;

    const ok = item.state === 'up';

    // /api/health içinden gelen version öncelikli
    const hv = healthVersions[id];

    const version =
      hv ||
      item.version ||
      item.app_version ||
      item.build ||
      null;

    return {
      key: id,
      name: item.name || id.toUpperCase(),
      type: 'systemd',
      ok,
      statusText: item.state || 'unknown',
      extraLabel: 'Unit',
      extraValue: item.unit || '',
      version,
    };
  }

  function normalizeDocker(item) {
    const running = item.running === true || /^up/i.test(item.status || '');
    const keyName = (item.name || item.id || '').toLowerCase();

    // /api/health içinde bu isimle version varsa al
    const hv = healthVersions[keyName];

    let version = hv || item.version || null;

    // Hâlâ yoksa image tag'den çek
    if (!version && item.image && item.image.includes(':')) {
      const tag = item.image.split(':').pop();
      version = tag;
    }

    return {
      key: item.name || item.id,
      name: item.name || item.id,
      type: 'docker',
      ok: running,
      statusText: item.status || (running ? 'running' : 'stopped'),
      extraLabel: 'Image',
      extraValue: item.image || '',
      version,
    };
  }

  // ---------- Kart üretimi ----------
function makeCard(svc) {
  const stateCls = svc.ok ? 'ok' : 'bad';
  const section = el('section', {
    className: `card ${stateCls}`,
    tabindex: 0,
  });
  
  // // Docker kartına tıklayınca container loglarına git
  // if (svc.type === 'docker') {
  //   section.style.cursor = 'pointer';
  //   section.addEventListener('click', () => {
  //     const containerName = svc.key || svc.name;
  //     window.location.href =
  //       '/static/logs-service.html?container=' + encodeURIComponent(containerName);
  //   });
  // }

  // Systemd kartına tıklayınca systemd loglarına git
  if (svc.type === 'systemd') {
    section.style.cursor = 'pointer';
    section.addEventListener('click', () => {
      const serviceId = svc.key;   // bind9, kea, nginx, system-service
      window.location.href =
        '/static/logs-service.html?service=' + encodeURIComponent(serviceId);
    });
  }

  // Başlık: sadece servis adı
  const title = el('h2', {}, [
    el('span', { textContent: svc.name }),
    rh(stateCls),
  ]);

  // Badgeler
  const badges = [];

  badges.push(
    el('span', { className: 'badge' }, [
      el('span', { className: 'proto', textContent: 'TYPE' }),
      el('span', { textContent: ':' }),
      el('code', { textContent: svc.type }),
    ]),
  );

  if (svc.extraValue) {
    badges.push(
      el('span', { className: 'badge' }, [
        el('span', { className: 'proto', textContent: svc.extraLabel }),
        el('span', { textContent: ':' }),
        el('code', { textContent: svc.extraValue }),
      ]),
    );
  }

  // Versiyon badge
  if (svc.version) {
    badges.push(
      el('span', { className: 'badge' }, [
        el('span', { className: 'proto', textContent: 'VERSION' }),
        el('span', { textContent: ':' }),
        el('code', { textContent: String(svc.version) }),
      ]),
    );
  }
  // <<<

  const badgesWrap = el('div', { className: 'badges' }, badges);

  const statusTextEl = el('span', {
    className: 'status-text',
    textContent: svc.statusText,
  });
  const rows = [];
  rows.push(
    el('div', { className: 'row' }, [
      el('span', { className: 'label', textContent: 'Durum' }),
      el('span', { className: 'val' }, [
        chip(svc.ok ? 'ok' : 'bad', svc.statusText),
        statusTextEl,
      ]),
    ]),
  );

  const meta = el('div', { className: 'meta' }, rows);

  const actions = [];
  let actionButtons = null;

  if (svc.type === 'docker') {
    const isRunning = svc.ok;
    actionButtons = [];

    const stopStartBtn = el('button', {
      className: 'btn card-action danger',
      type: 'button',
      textContent: isRunning ? 'Docker Stop' : 'Docker Start',
    });
    stopStartBtn.addEventListener('click', async (event) => {
      event.preventDefault();
      stopStartBtn.disabled = true;

      const isStopAction = isRunning;
      const setStopPending = (pending) => {
        section.classList.toggle('is-stopping', pending);
        statusTextEl.textContent = pending ? 'Bekleyiniz...' : svc.statusText;
        stopStartBtn.textContent = pending
          ? 'Bekleyiniz...'
          : isRunning
            ? 'Docker Stop'
            : 'Docker Start';
        actionButtons.forEach((btn) => {
          btn.disabled = pending;
        });
      };
      if (isStopAction) {
        setStopPending(true);
      }
      let actionSucceeded = false;

      try {
        const action = isRunning ? 'stop' : 'start';
        await postDockerAction(svc.key || svc.name, action);
        await loadOnce();
      } catch (err) {
        console.error(err);
        alert(isRunning ? 'Docker Stop işlemi başarısız.' : 'Docker Start işlemi başarısız.');
        if(isStopAction){
          setStopPending(false);
        }
      } finally {
        if (isStopAction && actionSucceeded) {
          return;
        }
        stopStartBtn.disabled = false;
      }
    });

    const restartBtn = el('button', {
      className: 'btn card-action danger',
      type: 'button',
      textContent: 'Docker Restart',
    });
    restartBtn.addEventListener('click', async (event) => {
      event.preventDefault();
      const setRestartPending = (pending) => {
        section.classList.toggle('is-stopping', pending);
        statusTextEl.textContent = pending ? 'Bekleyiniz...' : svc.statusText;
        restartBtn.textContent = pending ? 'Bekleyiniz...' : 'Docker Restart';
        actionButtons.forEach((btn) => {
          btn.disabled = pending;
        });
      };
      setRestartPending(true);      
      try {
        await postDockerAction(svc.key || svc.name, 'restart');
        await loadOnce();
      } catch (err) {
        console.error(err);
      } finally {
        setRestartPending(false);
      }
    });
    actionButtons.push(stopStartBtn, restartBtn); 
    actions.push(stopStartBtn, restartBtn);
  }

  const logBtn = el('button', {
    className: 'btn card-action info',
    type: 'button',
    textContent: 'Logs',
  });
  logBtn.addEventListener('click', (event) => {
    event.preventDefault();
    if (svc.type === 'docker') {
      const containerName = svc.key || svc.name;
      window.location.href =
        '/static/logs-service.html?container=' + encodeURIComponent(containerName);
    } else if (svc.type === 'systemd') {
      const serviceId = svc.key;
      window.location.href =
        '/static/logs-service.html?service=' + encodeURIComponent(serviceId);
    }
  });
  if (actionButtons) {
    actionButtons.push(logBtn);
  }
  actions.push(logBtn);

  const footer = el('div', { className: 'card-footer' }, [
    el('div', { className: 'card-actions' }, actions),
  ]);

  section.append(title, badgesWrap, meta, footer);  return section;
}


  // ---------- DOM referansları ----------
  const gridEl = document.getElementById('grid');
  const loadingEl = document.getElementById('loading');
  const statTotal = document.getElementById('statTotal');
  const statOk = document.getElementById('statOk');
  const statBad = document.getElementById('statBad');
  const scoreEl = document.getElementById('score');
  const scoreVal = document.getElementById('scoreVal');
  const searchInput = document.getElementById('search');

  function setLoading(on) {
    loadingEl.style.display = on ? 'block' : 'none';
  }

  function updateStats(services) {
    const total = services.length;
    const okCount = services.filter((s) => s.ok).length;
    const badCount = total - okCount;
    const score = total ? Math.round((okCount / total) * 100) : 0;

    statTotal.textContent = total;
    statOk.textContent = okCount;
    statBad.textContent = badCount;
    scoreEl.style.setProperty('--p', score);
    scoreVal.textContent = `${score}%`;
  }

  function renderGrid() {
    const q = (searchInput?.value || '').trim().toLowerCase();

    const filterFn = (svc) => {
      if (!q) return true;
      return (
        (svc.name && svc.name.toLowerCase().includes(q)) ||
        (svc.type && svc.type.toLowerCase().includes(q)) ||
        (svc.extraValue && svc.extraValue.toLowerCase().includes(q)) ||
        (svc.version && String(svc.version).toLowerCase().includes(q))
      );
    };

    const filteredStatic = staticServices.filter(filterFn);
    const filteredDynamic = dynamicServices.filter(filterFn);
    const allFiltered = [...filteredStatic, ...filteredDynamic];

    const fragment = document.createDocumentFragment();

    if (filteredStatic.length) {
      const staticCards = filteredStatic.map(makeCard);
      const staticGroup = el('section', { className: 'group' }, [
        el('div', { className: 'group-title', textContent: 'Systemd' }),
        el('div', { className: 'group-cards' }, staticCards),
      ]);
      fragment.append(staticGroup);
    }

    if (filteredDynamic.length) {
      const dynamicCards = filteredDynamic.map(makeCard);
      const dynamicGroup = el('section', { className: 'group' }, [
        el('div', { className: 'group-title', textContent: 'Docker' }),
        el('div', { className: 'group-cards docker-cards' }, dynamicCards),
      ]);
      fragment.append(dynamicGroup);
    }

    gridEl.innerHTML = '';
    if (!filteredStatic.length && !filteredDynamic.length) {
      gridEl.textContent = 'Eşleşen servis bulunamadı.';
    } else {
      gridEl.append(fragment);
    }

    updateStats(allFiltered);
  }

  async function loadOnce() {
    try {
      setLoading(true);
      gridEl.innerHTML = '';

      const [systemdList, dockerList, healthData] = await Promise.all([
        fetchJSON(CONFIG.SYSTEMD_URL),
        fetchJSON(CONFIG.DOCKER_URL).catch(() => []),
        fetchJSON(CONFIG.HEALTH_URL).catch(() => ({})),
      ]);

      healthVersions = {};
      if (healthData && typeof healthData === 'object') {
        for (const [name, item] of Object.entries(healthData)) {
          if (!item || !Object.prototype.hasOwnProperty.call(item, 'version')) continue;

          const v = item.version;
          if (v == null || v === '') continue;  

          healthVersions[name.toLowerCase()] = String(v);
        }
      }
      
      await enrichSystemServiceVersion();



      staticServices = [];
      dynamicServices = [];

      if (Array.isArray(systemdList)) {
        for (const item of systemdList) {
          const s = normalizeSystemd(item);
          if (s) staticServices.push(s);
        }
      }

      if (Array.isArray(dockerList)) {
        for (const item of dockerList) {
          dynamicServices.push(normalizeDocker(item));
        }
      }

      renderGrid();

    } catch (err) {
      console.error(err);
      gridEl.textContent = 'API hatası: ' + err.message;
    } finally {
      setLoading(false);
    }
  }

  // Refresh butonu
  const refreshBtn = document.getElementById('refresh');
  const refreshIcon = document.getElementById('refreshIcon');
  refreshBtn.addEventListener('click', async () => {
    refreshIcon.classList.add('spin');
    await loadOnce();
    refreshIcon.classList.remove('spin');
  });

  // Search input
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      renderGrid();
    });
  }


async function loadSystemInfo() {
  try {
    const res = await fetch('/api/system-info');
    if (!res.ok) return;

    const data = await res.json();
    if (!data) return;

    // Kernel
    const kEl = document.getElementById('kernelText');
    if (kEl && data.kernel) {
      kEl.textContent = data.kernel;
    }

    // Distro
    const dEl = document.getElementById('distroText');
    if (dEl) {
      const pretty = data.pretty_name || '';
      const code   = data.version_codename || '';
      const like   = data.id_like || '';

      let text = pretty || '';

      const extra = [];

      // 1) codename PRETTY_NAME içinde zaten geçiyorsa tekrar ekleme
      if (code) {
        const prettyLower = pretty.toLowerCase();
        const codeLower = code.toLowerCase();
        if (!prettyLower.includes(codeLower)) {
          extra.push(code);
        }
      }

      // 2) id_like varsa ekle
      if (like) {
        extra.push(like);
      }

      // 3) ekstra varsa PRETTY_NAME sonuna ekle
      if (extra.length > 0) {
        text = text || 'Linux';
        text += ` (${extra.join(' / ')})`;
      }

      // 4) hiçbir bilgi yoksa
      if (!text) {
        text = 'N/A';
      }

      dEl.textContent = text;
    }

  } catch (e) {
    console.error('system-info alınamadı', e);
  }
}
async function enrichSystemServiceVersion() {
  try {
    const res = await fetch('/api/system-service/version', {
      headers: { Accept: 'application/json' },
    });
    if (!res.ok) {
      console.error('system-service/version http error', res.status);
      return;
    }
    const data = await res.json();
    if (!data || !data.version) return;

    // healthVersions içine override edelim
    healthVersions['system-service'] = String(data.version);
  } catch (err) {
    console.error('system-service/version fetch error', err);
  }
}



// Sayfa açılırken hem sistem bilgisini hem kartları yükle
async function init() {
  await loadSystemInfo();  // kernel + distro
  await loadOnce();        // kartlar
}

init();

</script>
</body>
</html>