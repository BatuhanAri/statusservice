<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Logs-Service | IFE Health Dashboard</title>

  <meta id="themeColor" name="theme-color" content="#020617">

  <style>
    :root {
      --bg:#020617;
      --fg:#e5edf7;
      --muted:#9aa6b2;

      --card:#020f2b;
      --bd:#1f2a44;
      --hr:#111827;
      --na:#324158;

      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;

      --brand1:#2563eb;
      --brand2:#22d3ee;
      --brand3:#4f46e5;

      --glow: 0 10px 30px -10px rgba(34,211,238,.35),
               0 6px 18px -8px rgba(37,99,235,.35);

      --radius:14px;
      --focus: 0 0 0 3px rgba(34,211,238,.5);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 15px/1.45 ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(37,99,235,.25), transparent 60%),
        radial-gradient(900px 700px at 110% 10%, rgba(79,70,229,.20), transparent 60%),
        var(--bg);
      background-attachment: fixed;
      color:var(--fg);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      backdrop-filter:saturate(140%) blur(12px);
      background:
        linear-gradient(90deg, rgba(15,23,42,.85), rgba(30,64,175,.96));
      border-bottom:1px solid rgba(15,23,42,.85);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:26px;height:26px;border-radius:9px;
      background: conic-gradient(from 210deg, var(--brand1), var(--brand2), var(--brand3), var(--brand1));
      box-shadow:var(--glow);
    }
    header h1{
      margin:0;
      font-size:1rem;
      letter-spacing:.2px;
    }

    .header-actions{
      display:flex;
      gap:8px;
    }
    .btn{
      appearance:none;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(15,23,42,.4);
      color:#fff;
      padding:6px 12px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn:hover{
      background:rgba(15,23,42,.7);
    }

    main{
      flex:1 0 auto;
      padding:14px;
      max-width:1420px;
      margin:0 auto 24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* ÜSTTEKİ mini kart grid */
    .container-grid{
      background:rgba(15,23,42,.9);
      border-radius:16px;
      border:1px solid var(--bd);
      padding:10px 12px 12px;
    }
    .container-grid-title{
      font-size:.8rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
      margin:0 0 6px;
    }
    .mini-grid{
      display:grid;
      gap:6px;
      grid-template-columns: repeat(8, minmax(0,1fr)); /* geniş ekranda 8 sütun */
    }
    @media (max-width:1200px){
      .mini-grid{
        grid-template-columns:repeat(4,minmax(0,1fr));
      }
    }
    @media (max-width:768px){
      .mini-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }

    .mini-card{
      background:
        radial-gradient(circle at 0 0, rgba(37,99,235,.25), transparent 55%),
        radial-gradient(circle at 100% 0, rgba(96,165,250,.20), transparent 55%),
        var(--card);
      border:1px solid var(--bd);
      border-left-width:6px;
      border-radius:var(--radius);
      padding:10px 12px;
      box-shadow:0 4px 18px rgba(0,0,0,.45);
      transition: transform .18s ease, box-shadow .18s ease, border-color .2s ease, background .2s ease;
      font-size:.8rem;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:60px;
    }

    /* main'deki card.ok / card.bad gibi */
    .mini-card.ok{
      border-left-color:var(--ok);
    }
    .mini-card.bad{
      border-left-color:var(--bad);
    }

    .mini-card:hover{
      transform:translateY(-2px);
      box-shadow:0 14px 32px rgba(0,0,0,.65);
      border-color:rgba(59,130,246,.75);
      background:
        radial-gradient(circle at 0 0, rgba(59,130,246,.45), transparent 60%),
        radial-gradient(circle at 100% 0, rgba(37,99,235,.35), transparent 60%),
        var(--card);
    }

    .mini-card.active{
      box-shadow:0 0 0 1px rgba(56,189,248,.7), 0 14px 32px rgba(0,0,0,.65);
    }

    /* Üst satır için küçük header */
    .mini-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
    }

    .mini-name{
      font-weight:600;
      word-break:break-all;
    }

    .mini-status{
      font-size:.7rem;
      color:var(--muted);
    }

    /* Sağdaki küçük dot */
    .mini-dot{
      width:10px;
      height:10px;
      border-radius:3px;
    }
    .mini-dot.okdot{ background:var(--ok); }
    .mini-dot.baddot{ background:var(--bad); }

    /* Log panel */
    #log-panel{
      margin-top:4px;
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px 16px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .log-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .log-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .log-toggle{
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      font-size:18px;
      line-height:1;
    }

    .log-body{
      background:#020617;
      border-radius:12px;
      padding:8px 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      line-height:1.4;
      max-height:300px;
      overflow-y:auto;
    }

    .log-line{
      padding:2px 0;
      white-space:pre-wrap;
      word-break:break-all;
    }

    .log-info{ color:var(--muted); }
    .log-warn{ color:var(--warn); }
    .log-error{ color:var(--bad); }

    .log-pagination{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:12px;
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }

    .log-pagination button{
      border-radius:999px;
      border:1px solid var(--bd);
      background:transparent;
      padding:4px 10px;
      font-size:11px;
      cursor:pointer;
      color: #e5edf7;
      font-weight: 600;
    }
    .log-pagination button:disabled{
      opacity:0.4;
      cursor:default;
    }

    #log-panel.collapsed .log-body,
    #log-panel.collapsed .log-pagination{
      display:none;
    }
    #log-panel.collapsed .log-toggle{
      transform:rotate(180deg);
    }

    footer{
      margin-top:auto;
      padding:8px 14px;
      align-items: center;
      border-top:1px solid var(--bd);
      background:rgba(15,23,42,.96);
      font-size:.8rem;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"></div>
      <h1>Logs-Service</h1>
    </div>
    <div class="header-actions">
      <a class="btn" href="/">Health Dashboard</a>
    </div>
  </header>

    <main>
      <section class="container-grid">
        <p class="container-grid-title">System Services (journalctl)</p>
        <div id="sysGrid" class="mini-grid">
        </div>
      </section>

      <section class="container-grid">
        <p class="container-grid-title">Docker Containers</p>
        <div id="miniGrid" class="mini-grid">
        </div>
      </section>

      <section id="log-panel" aria-label="Log paneli">
        <header class="log-header">
          <h2 id="logTitle">Loglar</h2>
          <button class="log-toggle" type="button" aria-label="Log panelini gizle">⌄</button>
        </header>

        <div class="log-body" id="log-body">
          <div class="log-line log-info">
              Yukarıdan bir system service veya container seçin.
          </div>
        </div>

        <div class="log-pagination">
          <button id="log-prev-btn" type="button">⬅ Older</button>
          <span id="log-page-info">Page 1 / 1</span>
          <button id="log-next-btn" type="button">Newer ➡</button>
        </div>
      </section>
    </main>

    <footer>
      @TCI.DevOps Team · Logs-Service
    </footer>

    <script type="module">
    const SYSTEMD_URL = '/api/system-services';
    const DOCKER_URL = '/api/docker-services';
    const SYSTEM_LOGS_URL = '/api/system-logs';


    let allLogLines = [];
    let currentPage = 1;
    const pageSize = 100;

    let selectedContainer = null;
    let selectedSystemService = null;
    let systemMeta = []; 

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function fetchJSON(url) {
      const res = await fetch(url, { headers: { Accept: 'application/json' }});
      if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
      return res.json();
    }

    /* ---------- SYSTEMD SERVICES (ÜST GRID) ---------- */

    async function loadSystemServices() {
    const grid = document.getElementById('sysGrid');
    grid.innerHTML = 'System services yükleniyor...';

    const items = await fetchJSON(SYSTEMD_URL).catch(() => null);

    if (!Array.isArray(items) || items.length === 0) {
      grid.textContent = 'System service bulunamadı.';
      return;
    }

  // title vs için meta burada dursun
    systemMeta = items;
    grid.innerHTML = '';

      items.forEach(item => {
        const running = item.state === 'up';
        const stateCls = running ? 'ok' : 'bad';
        const dotCls   = running ? 'okdot' : 'baddot';

        const card = document.createElement('div');
        card.className = `mini-card ${stateCls}`;
        card.dataset.serviceId = item.id;

        card.innerHTML = `
          <div class="mini-header">
            <span class="mini-name">${item.name || item.id}</span>
            <span class="mini-dot ${dotCls}"></span>
          </div>
          <div class="mini-status">
            ${item.state || 'unknown'}${item.unit ? ' · ' + item.unit : ''}
          </div>
        `;

        card.addEventListener('click', () => {
          selectSystemService(item.id);
        });

        grid.appendChild(card);
      });
    }


    function markActiveSystemCard(idOrNull) {
      const grid = document.getElementById('sysGrid');
      if (!grid) return;
      grid.querySelectorAll('.mini-card').forEach(c => {
        if (!idOrNull) {
          c.classList.remove('active');
        } else if (c.dataset.serviceId === idOrNull) {
          c.classList.add('active');
        } else {
          c.classList.remove('active');
        }
      });
    }

    async function selectSystemService(serviceId) {
      selectedSystemService = serviceId;
      selectedContainer = null;
      markActiveSystemCard(serviceId);
      // container active'leri temizle
      markActiveCard(null);

      const meta = systemMeta.find(x => x.id === serviceId);
      const titleEl = document.getElementById('logTitle');
      titleEl.textContent = `Loglar · ${meta ? (meta.name || meta.id) : serviceId}`;

      await loadSystemServiceLogs(serviceId);
    }

    async function loadSystemServiceLogs(serviceId) {
      const body = document.getElementById('log-body');
      body.innerHTML =
        `<div class="log-line log-info">${serviceId} için systemd logları yükleniyor...</div>`;

      try {
        const data = await fetchJSON(`${SYSTEM_LOGS_URL}?lines=800`);
        const item = (data.items || []).find(x => x.id === serviceId);

        if (!item || !item.logs) {
          body.innerHTML =
            `<div class="log-line log-info">Bu servis için log bulunamadı.</div>`;
          allLogLines = [];
          updatePaginationUI();
          return;
        }

        allLogLines = item.logs.split('\n').filter(Boolean).reverse();
        currentPage = 1;
        renderLogPage();
      } catch (e) {
        body.innerHTML =
          `<div class="log-line log-error">System logs alınırken hata: ${e}</div>`;
        allLogLines = [];
        updatePaginationUI();
      }
    }

    /* ---------- DOCKER CONTAINERS (ALT GRID) ---------- */

    async function loadContainers() {
      const list = await fetchJSON(DOCKER_URL).catch(() => []);
      const grid = document.getElementById('miniGrid');
      grid.innerHTML = '';

      if (!Array.isArray(list) || list.length === 0) {
        grid.textContent = 'Docker container bulunamadı.';
        return;
      }

      list.forEach(item => {
        const name = item.name || item.id;
        const status = item.status || (item.running ? 'running' : 'stopped');

        const running =
          item.running === true ||
          /^up/i.test(status) ||
          /^running/i.test(status);

        const stateCls = running ? 'ok' : 'bad';

        const card = document.createElement('div');
        card.className = `mini-card ${stateCls}`;
        card.dataset.container = name;

        card.innerHTML = `
          <div class="mini-header">
            <span class="mini-name">${name}</span>
            <span class="mini-dot ${running ? 'okdot' : 'baddot'}"></span>
          </div>
          <div class="mini-status">${status}</div>
        `;

        card.addEventListener('click', () => {
          selectContainer(name);
        });

        grid.appendChild(card);
      });

      const fromQuery = getQueryParam('container');
      if (fromQuery) {
        selectContainer(fromQuery);
      }
    }

    function markActiveCard(nameOrNull) {
      const grid = document.getElementById('miniGrid');
      if (!grid) return;
      grid.querySelectorAll('.mini-card').forEach(c => {
        if (!nameOrNull) {
          c.classList.remove('active');
        } else if (c.dataset.container === nameOrNull) {
          c.classList.add('active');
        } else {
          c.classList.remove('active');
        }
      });
    }

    async function selectContainer(containerName) {
      selectedContainer = containerName;
      selectedSystemService = null;
      markActiveCard(containerName);
      // systemd kartlarını temizle
      markActiveSystemCard(null);

      const titleEl = document.getElementById('logTitle');
      titleEl.textContent = `Loglar · ${containerName}`;

      await loadContainerLogs(containerName);
    }

    async function loadContainerLogs(containerName) {
      const body = document.getElementById('log-body');
      body.innerHTML =
        `<div class="log-line log-info">${containerName} için loglar yükleniyor...</div>`;

      try {
        const res = await fetch(`/api/docker-logs/${encodeURIComponent(containerName)}?tail=800`);
        if (!res.ok) {
          body.innerHTML =
            `<div class="log-line log-error">Loglar alınamadı: ${res.status}</div>`;
          allLogLines = [];
          updatePaginationUI();
          return;
        }

        const data = await res.json();

        allLogLines = (data.lines || []).slice().reverse();
        currentPage = 1;
        renderLogPage();
      } catch (e) {
        body.innerHTML =
          `<div class="log-line log-error">Hata: ${e}</div>`;
        allLogLines = [];
        updatePaginationUI();
      }
    }

    /* ---------- ORTAK LOG RENDER / PAGINATION ---------- */

    function renderLogPage() {
      const body = document.getElementById('log-body');
      body.innerHTML = '';

      const total = allLogLines.length;
      if (total === 0) {
        body.innerHTML = `<div class="log-line log-info">Gösterilecek log yok.</div>`;
        updatePaginationUI();
        return;
      }

      const totalPages = Math.max(1, Math.ceil(total / pageSize));

      if (currentPage > totalPages) currentPage = totalPages;
      if (currentPage < 1) currentPage = 1;

      const start = (currentPage - 1) * pageSize;
      const end   = Math.min(total, start + pageSize);
      const linesForPage = allLogLines.slice(start, end);

      for (const line of linesForPage) {
        const div = document.createElement('div');
        const upper = line.toUpperCase();

        if (upper.includes('ERROR')) div.className = 'log-line log-error';
        else if (upper.includes('WARN')) div.className = 'log-line log-warn';
        else div.className = 'log-line log-info';

        div.textContent = line;
        body.appendChild(div);
      }

      updatePaginationUI(totalPages);
    }

    function updatePaginationUI(totalPagesParam) {
      const total = allLogLines.length;
      const totalPages = totalPagesParam || Math.max(1, Math.ceil(Math.max(1, total) / pageSize));

      const infoEl = document.getElementById('log-page-info');
      const prevBtn = document.getElementById('log-prev-btn');
      const nextBtn = document.getElementById('log-next-btn');

      if (infoEl) {
        infoEl.textContent = `Page ${currentPage} / ${totalPages}`;
      }
      if (prevBtn) prevBtn.disabled = (currentPage >= totalPages);
      if (nextBtn) nextBtn.disabled = (currentPage <= 1);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('log-prev-btn').addEventListener('click', () => {
        currentPage += 1;
        renderLogPage();
      });
      document.getElementById('log-next-btn').addEventListener('click', () => {
        currentPage -= 1;
        renderLogPage();
      });

      const toggleBtn = document.querySelector('.log-toggle');
      const logPanel  = document.getElementById('log-panel');
      toggleBtn.addEventListener('click', () => {
        logPanel.classList.toggle('collapsed');
      });

      // Önce grid'leri yükle
      await loadSystemServices();
      await loadContainers();

      // URL param: ?service=system-service  -> systemd log
      const svcFromUrl = getQueryParam('service');
      if (svcFromUrl) {
        selectSystemService(svcFromUrl);
        return;
      }

      // URL param: ?container=xyz  -> docker log
      const containerFromUrl = getQueryParam('container');
      if (containerFromUrl) {
        selectContainer(containerFromUrl);
      }
    });

  </script>
</body>
</html>
