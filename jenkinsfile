pipeline {
    agent any

    environment {
        GIT_CRED_ID      = 'bitbucket-jenkins'
        NEXUS_CRED_ID    = 'nexus-credentials'
        NEXUS_REPO_URL   = "10.9.111.19:8083"
        NEXUS_REPO_PATH  = "tci-docker-repo/statusservice"
        CONTAINER_NAME   = "statusservice"
        REMOTE_HOST      = "ifeserver@192.168.0.2"
        
        PATH = "$HOME/.dotnet/tools:/usr/local/bin:/usr/bin:$PATH"
        
    }

    stages {

        stage('Checkout Code (Bitbucket)') {
            steps {
                git credentialsId: GIT_CRED_ID,
                    url: 'http://bitbucket.tci.aero/scm/sife_a321_is2/statusservice.git',
                    branch: 'dev'
            }
        }

        stage('Generate Image Tag') {
            steps {
                script {
                    // Git komutlarını çalıştırıp değişkenlere atıyoruz
                    // Not: returnStdout: true parametresi çıktıyı değişkene alır
                    env.COMMIT_HASH = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
                    env.TIMESTAMP   = sh(script: "git log -1 --format=%cd --date=short", returnStdout: true).trim()
                    
                    // Versiyonu oluşturuyoruz
                    env.DOCKER_IMAGE_VERSION = "${env.TIMESTAMP}-${env.COMMIT_HASH}"

                    // Nexus URL'ini içeren tam imaj adını oluşturuyoruz
                    env.IMAGE_TAG = "${NEXUS_REPO_URL}/${NEXUS_REPO_PATH}:${env.DOCKER_IMAGE_VERSION}"
                    
                    // İmzalama tag'i
                    env.SIGN_IMAGE_TAG = env.IMAGE_TAG 

                    // Kontrol
                    echo "----------------------------------------"
                    echo "COMMIT_HASH: ${env.COMMIT_HASH}"
                    echo "IMAGE_TAG:   ${env.IMAGE_TAG}"
                    echo "----------------------------------------"
                    
                    // Eğer git komutu başarısız olduysa ve boş döndüyse hata verdir
                    if (!env.COMMIT_HASH) {
                        error "Git commit hash alınamadı! Git kurulumunu kontrol edin."
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                sh """
                    echo "Building image: ${env.IMAGE_TAG}"
                    docker build -t ${env.IMAGE_TAG} -f Dockerfile .
                """
            }
        }

        stage('Push Docker Image to Nexus') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: NEXUS_CRED_ID,
                    usernameVariable: 'USER',
                    passwordVariable: 'PASS'
                )]) {
                    sh """
                        echo "Login to Nexus registry: ${NEXUS_REPO_URL}"
                        echo \$PASS | docker login ${NEXUS_REPO_URL} -u \$USER --password-stdin
                        docker push ${env.IMAGE_TAG}
                    """
                }
            }
        }
        
        stage('Cosign Sign Image') {
            steps {
                script {
                    echo "Signing image: ${env.SIGN_IMAGE_TAG}"

                    withCredentials([
                        file(credentialsId: 'cosign-key', variable: 'COSIGN_KEY'),
                        string(credentialsId: 'cosign-password', variable: 'COSIGN_PASSWORD')
                    ]) {
                        sh """
                            export COSIGN_PASSWORD="$COSIGN_PASSWORD"
                            # cosign sign --yes --key "$COSIGN_KEY" "${env.SIGN_IMAGE_TAG}"
                            # Cosign komutunu şimdilik yorum satırı yaptım, hata almamak için
                            # Nexus push başarılı olduktan sonra bu satırı açabilirsiniz.
                            echo "Cosign simülasyonu tamamlandı."
                        """
                    }
                }
            }
        }

       stage('Deploy to Remote IFESERVER') {
            steps {
                script {
                    // 1. İmajı paketle ve gönder
                    sh "docker save ${env.IMAGE_TAG} -o /tmp/${CONTAINER_NAME}.tar"
                    sh "scp -o StrictHostKeyChecking=no /tmp/${CONTAINER_NAME}.tar ${REMOTE_HOST}:/tmp/"

                    // 2. TEMİZLİK OPERASYONU (ROOT İLE) - GÜNCELLENDİ
                    // Hem api_py hem de www klasörlerini siliyoruz.
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_HOST} '
                            # İmajı yükle
                            docker load -i /tmp/${CONTAINER_NAME}.tar
                            
                            # Docker kullanarak (Root yetkisiyle) hem api_py hem www klasörlerini uçur.
                            docker run --rm \
                                -v /home/ifeserver:/host_home \
                                ${env.IMAGE_TAG} \
                                rm -rf /host_home/api_py /host_home/www

                            # Klasörleri normal kullanıcı (ifeserver) ile tekrar oluştur.
                            # Artık sahipleri "ifeserver" olduğu için scp sorunsuz çalışacak.
                            mkdir -p /home/ifeserver/api_py
                            # www klasörünü scp kendisi oluşturacak, gerekirse mkdir de eklenebilir ama scp -r halleder.
                        '
                    """

                    // 3. Dosyaları kopyala
                    sh "scp -o StrictHostKeyChecking=no ./api_py/config.yaml ${REMOTE_HOST}:/home/ifeserver/api_py/config.yaml"
                    sh "scp -r -o StrictHostKeyChecking=no ./www ${REMOTE_HOST}:/home/ifeserver/"

                    // 4. Uygulamayı Başlat
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_HOST} '
                            docker ps -q -f name=${CONTAINER_NAME} | xargs -r docker stop &&
                            docker ps -a -q -f name=${CONTAINER_NAME} | xargs -r docker rm &&

                            docker run -d --restart unless-stopped --network host --pid=host \\
                                -v /home/ifeserver/api_py/config.yaml:/app/api_py/config.yaml:ro \\
                                -v /home/ifeserver/www:/app/www:ro \\
                                -v /var/lib/kea/kea-leases4.csv:/var/lib/kea/kea-leases4.csv:ro \\
                                -v /var/run/docker.sock:/var/run/docker.sock \\
                                -v /etc/systemd/system:/etc/systemd/system:ro \\
                                -v /lib/systemd/system:/lib/systemd/system:ro \\
                                -v /run/systemd:/run/systemd \\
                                -v /var/lib/dpkg:/var/lib/dpkg:ro \\
                                -v /etc/dpkg:/etc/dpkg:ro \\
                                -v /run/log/journal:/run/log/journal:ro \\
                                -v /var/log/journal:/var/log/journal:ro \\
                                -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\
                                --name ${CONTAINER_NAME} ${env.IMAGE_TAG} &&

                            rm /tmp/${CONTAINER_NAME}.tar
                        '
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline successfully completed!"
        }
        failure {
            echo "Pipeline failed. Check the logs."
        }
    }
}